# GitHub Actions Deploy

## Auto Deploy

Is handled by GitHub Actions. See .github/workflows/deploy.yml.

The workflow is triggered by a manual dispatch. It will copy the latest version of the code to the server and start the docker compose.

For the initial deployment, with no files present on the server, the new SSL certificate will be issued as requested by certbot.
Be careful about the rate limits of certbot.
See <https://letsencrypt.org/docs/rate-limits/>

For any subsequent deployment, the SSL certificate will be renewed if necessary.
The docker compose will be restarted to use the latest version of the code.

## Requirements

- The server must be reachable via SSH
- The server must have docker and docker-compose installed
- The domain `www.datadrivensurvey.com` must be pointing to the server
- The port 80 and 443 must be open on the server
- The code must be pushed to the main branch
- Frontend must build without WARNINGS or ERRORS, any warning will result in a step failure. You can see warning in the logs when the app is running in development mode.

## Secrets

It is necessary to set the following secrets in the GitHub repository:
For SSH access to the server:

- SERVER_HOST (IP address or domain name of the server)
- SERVER_USERNAME (username to login to the server)
- SERVER_SSH_KEY (private key to login to the server)
- SERVER_SSH_KEY_PASSPHRASE (passphrase for the private key)

#### Environement Variables:

The environement variables are set in the `.env` file.
The idea is to have the same setup to use in developement and production.
The `.env` file is not commited to the repository.
It is generated by deploy workflow.

The exception is the frontend `.env.production` file.
It is committed to the repository.
It is used during the frontend build and contains the api url which is different in development and production.
It is not a sensitive information.

##### List of Secrets to necessary to generate the .env file

The following secrets are used to generate the `.env` file:

- `DATABASE_URL` (production)
- `JWT_SECRET_KEY` (production)

###### `JWT_SECRET_KEY`

The `JWT_SECRET_KEY` length depends on the algorithm you are using. We are using `HS256` algorithm, the length of the secret key should be 32 bytes. You can generate a secret key using the following command:

```bash
# generate a secret key of length 32 bytes
python -c "import os; import binascii; print(binascii.hexlify(os.urandom(32)))"
```

## Generate SSH key pair for Deploy Workflow

To be used by `appleboy/scp-action` to copy the files and run necessary commands (using SSH) on the remote server.

It is recommended to generate the key on your local machine.

Detailed instructions: <https://github.com/appleboy/scp-action#setting-up-a-ssh-key>

To generate a SSH key pair, you can use the following command:

```sh
ssh-keygen -t ed25519 -a 200 -C "no-reply@www.datadrivensurvey.com"
```

Current approach is to use a passphrase for the private key. The passphrase is stored as a secret in the GitHub repository. Please note that other popular SSH-CSP GitHub action, such as `webfactory/ssh-agent`, do not support the passphrase.

The private key content should be stored as a secret "SERVER_SSH_KEY" in the GitHub repository. Make sure to remove any tailing newlines from the private key content.

The public key content is stored in the file "~/.ssh/authorized_keys" on the server.

If you have terminal ssh access you can run this command on your local machine:

```sh
cat .ssh/key_name.pub | ssh admin@www.datadrivensurvey.com 'cat >> .ssh/authorized_keys'
```

## Target folder

Project will be saved on the users home directory on the server: /home/admin/dds

The advantage is that the user, "admin", has permissions to write to this folder.
This is necessary to allow the deploy workflow to copy the files to the server without manually creating target folder and setting up special permissions.

## Setup the infrastructure on `localhost`

Can be use full to test the infrastructure on `localhost`.
You will have to include the `nginx` server configuration to serve on port 443 using the self signed certificate.

This should not be used for development. Hot reloading will not work with this setup.

```conf
server {
    listen 443 ssl;
    server_name localhost;

    root /var/www/frontend;

    index index.html;

    # SSL configuration
    ssl_certificate /etc/self-signed-ssl/fullchain.pem;
    ssl_certificate_key /etc/self-signed-ssl/privkey.pem;

    # serve the react build
    location / {
        try_files $uri /index.html;
    }

    # serve the api
    location /api {
        rewrite ^/api(.*) /$1 break;
        proxy_pass http://backend:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

A volume is already mounted for `self-signed-ssl` in the `docker-compose.yml` file.
You need to place your certificate files in this folder.

### Generate self-signed certificates

To generate a self-signed SSL certificate for `localhost`, you can use the following command:

```sh
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout privkey.pem -out fullchain.pem -subj "/CN=localhost"
```

You will have a warning in the browser that the certificate is not trusted.
You can ignore this warning.

## Usefull comands to debug the infrastructure

### Check the status of the docker containers

```sh
docker ps -a
```

### Debuging Infrastructure

#### SSL certificate not ready

When the ssl certificate is non existant or expired, the nginx container will fail to start while certbot is requesting a new certificate. You can try to restart the nginx container to see if the certificate is now valid.

```
# check the name of the nginx container
docker logs dds-nginx-1
docker restart dds-nginx-1
```

#### Missing permissions

You might also make sure the user `admin` has the right permissions to the folder `/etc/letsencrypt/live/www.datadrivensurvey.com/` which is mapped inside the docker volume at `/volumes/certbot/conf/live/www.datadrivensurvey.com/` in the docker-compose.yml file.

When logged in with the user `admin` on the server using SSH, you can run the following command to set the permissions:

```
cd dds
sudo chmod +rx volumes/certbot/conf/
```

### Altering the database

The database in prod is running in a docker container. To access the database, you can use the following command:

```sh
# check the name of the database container, user and password
docker exec -it dds-db-1 mysql -uroot -proot
```

```mysql
USE dds;

SHOW TABLES;
```

### Renew the SSL certificate

First search for valid certificates:

```sh
docker exec dds-certbot-1 certbot certificates
```

If you already have a valid certificate consider checking the expiration date and eventually renew it.

```sh
docker exec dds-certbot-1 certbot certonly --webroot -w /var/www/letsencrypt -d www.datadrivensurvey.com --agree-tos --email your-email@example.comm
```

### Force renew the SSL certificate

If you want to force renew the SSL certificate, you can run the following command:

```sh
docker exec dds-certbot-1 certbot certonly --webroot -w /var/www/letsencrypt -d www.datadrivensurvey.com --agree-tos --email your-email@example.comm --force-renewal
```

You shall see the following output:

```sh
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for www.datadrivensurvey.com

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/www.datadrivensurvey.com-0002/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/www.datadrivensurvey.com-0002/privkey.pem
This certificate expires on 2024-07-31.
These files will be updated when the certificate renews.
NEXT STEPS:
- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to enable that functionality. See https://certbot.org/renewal-setup for instructions.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

```

It is important to consider the path where the new certificate has been stored by `certbot`:
`/etc/letsencrypt/live/www.datadrivensurvey.com-0002`

In case the folder is different than whats configured in `nginx`, you will have to update the `nginx` configuration file to point to the new certificate and reload the `nginx` container.

Check: `./volumes/nginx/nginx.conf`
